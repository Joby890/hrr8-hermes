<!DOCTYPE html>
<html>
<head>
<title>robot playgrond</title>
<script src="/socket.io/socket.io.js"></script>
<script src="js/external/babylon.2.2.js"></script>
<script src="js/loader.js"></script>
<script src="js/robotModel.js"></script>
<script type="text/javascript">
</script>
<style>
html,body {
  overflow: hidden;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
#renderCanvas {
  width: 100%;
  height: 100%;
  touch-action: none;
}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<script>
var socket = io();
socket.on('connection', function() {
  console.log('Connected');
});

var USER_INPUT = {};
USER_INPUT['FORWARD'] = 0;
USER_INPUT['BACK'] = 0;
USER_INPUT['RIGHT'] = 0;
USER_INPUT['LEFT'] = 0;
window.addEventListener('keydown', function(e) {
  switch (e.keyCode) {
    case 87:
      USER_INPUT['FORWARD'] = 1;
      break;
    case 65:
      USER_INPUT['LEFT'] = 1;
      break;
    case 68:
      USER_INPUT['RIGHT'] = 1;
      break;
    case 83:
      USER_INPUT['BACK'] = 1;
      break;
    }
  //socket.emit('move',USER_INPUT);
});
window.addEventListener('keyup', function(e) {
  switch (e.keyCode) {
    case 87:
      USER_INPUT['FORWARD'] = 0;
      break;
    case 65:
      USER_INPUT['LEFT'] = 0;
      break;
    case 68:
      USER_INPUT['RIGHT'] = 0;
      break;
    case 83:
      USER_INPUT['BACK'] = 0;
      break;
    }
  //socket.emit('move',USER_INPUT);
});

// BABYLON setup
var canvas = document.getElementById('renderCanvas');
var engine = new BABYLON.Engine(canvas,true);
var scene = new BABYLON.Scene(engine);

// files to load
var assets = [
{ 'name' : 'Skitter',
    'file' : 'Assets/enemy@idleRun.babylon' },
{ 'name' : 'Plane001',
    'file' : "Assets/testEnv.babylon" },
{ 'name' : 'Cylinder014',
    'file' : 'Assets/testEnv.babylon' }
];

// preload assets
loadAssets(assets,0.02,scene,false,readyGo);

// set scene and begin render loop
function readyGo(meshes) {
  var bob = new Robot(0,new BABYLON.Vector3(0,2,0),meshes['Skitter'],meshes['Skitter'].skeleton);

  // ground
  meshes['Plane001'].setEnabled(true);
  meshes['Plane001'].scaling = new BABYLON.Vector3(0.1,0.1,0.1);
  meshes['Plane001'].material.diffuseTexture.uScale = 0.1;
  meshes['Plane001'].material.diffuseTexture.vScale = 0.1;
  // columns
  meshes['Cylinder014'].setEnabled(true);
  meshes['Cylinder014'].scaling = new BABYLON.Vector3(0.1,0.1,0.1);
  meshes['Cylinder014'].position = new BABYLON.Vector3(200,0,-70);

  var camera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0,5,-10), scene);
  camera.setTarget(BABYLON.Vector3.Zero());
  camera.attachControl(canvas,false);

  var chaseCam = new BABYLON.FollowCamera('FollowCam', new BABYLON.Vector3(2,3,1), scene);
  chaseCam.target = bob.pivot;
  chaseCam.radius = 7;
  chaseCam.heightOffset = 2;
  chaseCam.rotationOffset = 90;
  chaseCam.cameraAcceleration = 0.1;
  chaseCam.maxCameraSpeed = 10;

  var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0),scene);
  light.diffuse = new BABYLON.Color3(1,1,1);
  light.specular = new BABYLON.Color3(1,1,1);
  light.groundColor = new BABYLON.Color3(0.4,0.4,0.4);

  var light3 = new BABYLON.SpotLight('spotlight', new BABYLON.Vector3(0,5,-10), new BABYLON.Vector3(0,0,0.9), 0.7,1, scene);
  light3.diffuse = new BABYLON.Color3(1,1,1);
  light3.specular = new BABYLON.Color3(1,1,1);

  var shadowGenerator = new BABYLON.ShadowGenerator(1024,light3);
  shadowGenerator.getShadowMap().renderList.push(bob.mesh);
  var shadowG2 = new BABYLON.ShadowGenerator(2048,light);
  shadowG2.getShadowMap().renderList.push(bob.mesh);

  engine.runRenderLoop(function() {
    bob.update(USER_INPUT); 
    scene.render();
  });
  
  window.addEventListener('resize', function() {
    engine.resize();
  });

  // additional listeners for debugging
  // use 'f' to switch between follow & chase cam
  // use 'p' to toggle debug layer
  var switchcam = false;
  var switchdebug = true;
  window.addEventListener('keydown', function(e) {
    if (e.keyCode===70) {
      if (switchcam) {
        scene.activeCamera = camera;
      } else {
        scene.activeCamera = chaseCam;
      }
      switchcam = !switchcam;
    }
    if (e.keyCode===80) {
      if (switchdebug) {
        scene.debugLayer.show();
      } else {
        scene.debugLayer.hide();
      }
      switchdebug = !switchdebug;
    }
  });
}
</script>
</body>
</html>
