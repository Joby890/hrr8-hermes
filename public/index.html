<!DOCTYPE html>
<html>
<head>
<title>robot playgrond</title>
<script src="js/external/babylon.2.2.js"></script>
<script src="js/robotModel.js"></script>
<script type="text/javascript">
</script>
<style>
html,body {
  overflow: hidden;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}
#renderCanvas {
  width: 100%;
  height: 100%;
  touch-action: none;
}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<script>
var USER_INPUT = {};
USER_INPUT['FORWARD'] = 0;
USER_INPUT['BACK'] = 0;
USER_INPUT['RIGHT'] = 0;
USER_INPUT['LEFT'] = 0;
window.addEventListener('keydown', function(e) {
  switch (e.keyCode) {
    case 87:
      USER_INPUT['FORWARD'] = 1;
      break;
    case 65:
      USER_INPUT['LEFT'] = 1;
      break;
    case 68:
      USER_INPUT['RIGHT'] = 1;
      break;
    case 83:
      USER_INPUT['BACK'] = 1;
      break;
    }
});
window.addEventListener('keyup', function(e) {
  switch (e.keyCode) {
    case 87:
      USER_INPUT['FORWARD'] = 0;
      break;
    case 65:
      USER_INPUT['LEFT'] = 0;
      break;
    case 68:
      USER_INPUT['RIGHT'] = 0;
      break;
    case 83:
      USER_INPUT['BACK'] = 0;
      break;
    }
});

var canvas = document.getElementById('renderCanvas');
var engine = new BABYLON.Engine(canvas,true);
var scene = new BABYLON.Scene(engine);

var robotMesh;
var groundMat = new BABYLON.StandardMaterial('groundmat', scene);
groundMat.alpha = 1;
groundMat.backFaceCulling = true;
groundMat.specularPower = 64;
groundMat.useSpecularOverAlpha = true;
groundMat.useAlphaFromDiffuseTexture = false;
groundMat.diffuseColor = new BABYLON.Color3(1.00, 1.00, 1.00);
groundMat_diffuseTexture = new BABYLON.Texture('Assets/seamless_ground_texture.jpg', scene);
groundMat_diffuseTexture.uScale = 0.1;
groundMat_diffuseTexture.vScale = 0.1;
groundMat_diffuseTexture.coordinatesMode = 0;
groundMat_diffuseTexture.uOffset = 0;
groundMat_diffuseTexture.vOffset = 0;
groundMat_diffuseTexture.uAng = 0;
groundMat_diffuseTexture.vAng = 0;
groundMat_diffuseTexture.level = 1;
groundMat_diffuseTexture.coordinatesIndex = 0;
groundMat_diffuseTexture.hasAlpha = false;
groundMat_diffuseTexture.getAlphaFromRGB = false;

groundMat.diffuseTexture = groundMat_diffuseTexture;

BABYLON.SceneLoader.ImportMesh('','Assets/','testEnv.babylon', scene, function(envMeshes) {
  envMeshes[0].material = groundMat;
  envMeshes[1].position = new BABYLON.Vector3(200,0,0);
  for(var i = 0; i < envMeshes.length; i++){
    envMeshes[i].scaling = new BABYLON.Vector3(0.1,0.1,0.1);
    envMeshes[i].receiveShadows = true;
  }

  BABYLON.SceneLoader.ImportMesh("Skitter", "Assets/", "enemy@idleRun.babylon", scene, function (newMeshes, particleSystems, skeletons) {
    robotMesh = newMeshes[0];
    robotMesh.scaling = new BABYLON.Vector3(0.02,0.02,0.02);
    robotMesh.position = new BABYLON.Vector3(0,0,0); 
    robotMesh.setEnabled(false);

    readyGo();
  });

});

function readyGo() {
  var bob = new Robot(0,new BABYLON.Vector3(0,2,0),robotMesh,robotMesh.skeleton);

  var camera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0,5,-10), scene);
  camera.setTarget(BABYLON.Vector3.Zero());
  camera.attachControl(canvas,false);

  var chaseCam = new BABYLON.FollowCamera('FollowCam', new BABYLON.Vector3(2,3,1), scene);
  chaseCam.target = bob.pivot;
  chaseCam.radius = 7;
  chaseCam.heightOffset = 2;
  chaseCam.rotationOffset = 90;
  chaseCam.cameraAcceleration = 0.1;
  chaseCam.maxCameraSpeed = 10;

  var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0,1,0),scene);
  light.diffuse = new BABYLON.Color3(1,1,1);
  light.specular = new BABYLON.Color3(1,1,1);
  light.groundColor = new BABYLON.Color3(0.4,0.4,0.4);

  var light3 = new BABYLON.SpotLight('light2', new BABYLON.Vector3(0,12,1), new BABYLON.Vector3(0,0,-0.9), 0.7,1, scene);
  light3.diffuse = new BABYLON.Color3(1,1,1);
  light3.specular = new BABYLON.Color3(1,1,1);

  var shadowGenerator = new BABYLON.ShadowGenerator(1024,light3);
  shadowGenerator.getShadowMap().renderList.push(bob.mesh);
  var shadowG2 = new BABYLON.ShadowGenerator(2048,light);
  shadowG2.getShadowMap().renderList.push(bob.mesh);

  engine.runRenderLoop(function() {
    //build inputObject

    bob.update(USER_INPUT); 
    scene.render();
  });
  window.addEventListener('resize', function() {
    engine.resize();
  });
  var switchcam = false;
  var switchdebug = true;
  window.addEventListener('keydown', function(e) {
    if (e.keyCode===70) {
      if (switchcam) {
        scene.activeCamera = camera;
      } else {
        scene.activeCamera = chaseCam;
      }
      switchcam = !switchcam;
    }
    if (e.keyCode===80) {
      if (switchdebug) {
        scene.debugLayer.show();
      } else {
        scene.debugLayer.hide();
      }
      switchdebug = !switchdebug;
    }
  });
}
</script>
</body>
</html>
